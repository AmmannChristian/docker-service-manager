# OIDC Configuration (ZITADEL) - Production Grade
# Application type: service = backend API, no web login redirects
quarkus.oidc.application-type=service

quarkus.oidc.auth-server-url=${OIDC_AUTH_SERVER_URL}
quarkus.oidc.client-id=${OIDC_CLIENT_ID}

# Discovery endpoint cache (reduces calls to /.well-known/openid-configuration)
# ZITADEL discovery endpoint is not exposed in local dev via this routing setup.
# Keep discovery enabled by default, but disable it in dev.
quarkus.oidc.discovery-enabled=true
%dev.quarkus.oidc.discovery-enabled=false
quarkus.oidc.jwks-path=/oauth/v2/keys

# Authentication Method: private_key_jwt (RFC 7523)
quarkus.oidc.credentials.jwt.key-file=${OIDC_JWT_KEY_FILE}
quarkus.oidc.credentials.jwt.token-key-id=${OIDC_JWT_KEY_ID}
quarkus.oidc.credentials.jwt.lifespan=${OIDC_JWT_LIFESPAN:300}
quarkus.oidc.credentials.jwt.signature-algorithm=RS256
# ZITADEL expects issuer URL as audience for private_key_jwt
quarkus.oidc.credentials.jwt.audience=${OIDC_JWT_AUDIENCE:${quarkus.oidc.auth-server-url}}

# Token Validation Settings
quarkus.oidc.token.audience=${OIDC_TOKEN_AUDIENCE:${quarkus.oidc.client-id}}
quarkus.oidc.token.verify-access-token-with-user-info=false

# Support both JWT (local verification) and opaque tokens (introspection)
quarkus.oidc.token.allow-opaque-token-introspection=true
quarkus.oidc.token.allow-jwt-introspection=false

# ZITADEL introspection endpoint
quarkus.oidc.introspection-path=/oauth/v2/introspect

# Roles Extraction (ZITADEL specific claim path)
quarkus.oidc.roles.source=accesstoken
quarkus.oidc.roles.role-claim-path=urn:zitadel:iam:org:project:roles

# Public paths that do not require authentication
quarkus.http.auth.permission.public.paths=/q/health/*,/q/metrics,/q/openapi,/q/openapi/*,/grpc.health.*,/grpc.reflection.*
quarkus.http.auth.permission.public.policy=permit

# Protected paths require authentication
quarkus.http.auth.permission.authenticated.paths=/api/*
quarkus.http.auth.permission.authenticated.policy=authenticated

# Allow CORS preflight requests (OPTIONS) without authentication
quarkus.http.auth.permission.cors-preflight.paths=/api/*
quarkus.http.auth.permission.cors-preflight.methods=OPTIONS
quarkus.http.auth.permission.cors-preflight.policy=permit

# HTTP Server Ports
quarkus.http.host=${HTTP_HOST:0.0.0.0}
quarkus.http.port=${HTTP_PORT:9080}
quarkus.http.ssl-port=${HTTPS_PORT:9443}

# HTTP Server CORS & HTTP/2
quarkus.http.cors.enabled=${HTTP_CORS_ENABLED:true}
quarkus.http.cors.origins=${HTTP_CORS_ORIGINS:/.*/}
quarkus.http.cors.methods=${HTTP_CORS_METHODS:GET,POST,PUT,DELETE,OPTIONS}
quarkus.http.cors.headers=${HTTP_CORS_HEADERS:accept,authorization,content-type,x-requested-with}
quarkus.http.cors.exposed-headers=${HTTP_CORS_EXPOSED_HEADERS:content-disposition}
quarkus.http.http2=${HTTP2_ENABLED:true}

# Apply TLS to HTTP server (f√ºr Traefik mTLS)
quarkus.http.insecure-requests=${HTTP_INSECURE_REQUESTS:disabled}
quarkus.http.ssl.client-auth=${HTTP_SSL_CLIENT_AUTH:required}
quarkus.http.tls-configuration-name=server-mtls

# TLS/mTLS Configuration - Dev Profile
quarkus.tls.server-mtls.key-store.p12.path=${KEY_STORE:/certs/server.p12}
quarkus.tls.server-mtls.key-store.p12.password=${KEY_STORE_PASSWORD:changeit}
quarkus.tls.server-mtls.trust-store.p12.path=${TRUST_STORE:/certs/ca.p12}
quarkus.tls.server-mtls.trust-store.p12.password=${TRUST_STORE_PASSWORD:changeit}
quarkus.tls.server-mtls.reload-period=15m

# Management Interface (Health Checks)
quarkus.management.enabled=true
quarkus.management.port=${MANAGEMENT_PORT:9090}
quarkus.smallrye-health.management.enabled=true

# Service Blacklist (Protected Containers)
service.blacklist=${SERVICE_BLACKLIST:}

# TLS bucket (dev-only)
%dev.quarkus.tls.authdev.trust-all=true
%dev.quarkus.tls.authdev.hostname-verification-algorithm=NONE
# OIDC (inbound)
%dev.quarkus.oidc.tls.tls-configuration-name=authdev

quarkus.service-manager.role=${NEEDED_SERVICE_MANAGMENT_ROLE:SERVICE_MANAGER_ROLE}